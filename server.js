var PORT = process.env.PORT || 3000; // take port from heroku or for loacalhost
var express = require("express");
var app = express(); // express app which is used boilerplate for HTTP
var http = require("http").Server(app);

//moment js
var moment = require("moment");

var clientInfo = {};

//socket io module
var io = require("socket.io")(http);

// expose the folder via express thought
app.use(express.static(__dirname + '/public'));

// send current users to provided scoket
function sendCurrentUsers(socket) { // loading current users
  var info = clientInfo[socket.id];
  var users = [];
  if (typeof info === 'undefined') {
    return;
  }
  // filte name based on rooms
  Object.keys(clientInfo).forEach(function(socketId) {
    var userinfo = clientInfo[socketId];
    // check if user room and selcted room same or not
    // as user should see names in only his chat room
    if (info.room == userinfo.room) {
      users.push(userinfo.name);
    }

  });
  // emit message when all users list

  socket.emit("message", {
    name: "System",
    text: "Current Users : " + users.join(', '),
    timestamp: moment().valueOf()
  });

}


// io.on listens for events
io.on("connection", function(socket) {
  console.log("User is connected");

  //for disconnection
  socket.on("disconnect", function() {
    var userdata = clientInfo[socket.id];
    if (typeof(userdata !== undefined)) {
      socket.leave(userdata.room); // leave the room
      //broadcast leave room to only memebers of same room
      socket.broadcast.to(userdata.room).emit("message", {
        text: userdata.name + " has left",
        name: "System",
        timestamp: moment().valueOf()
      });

      // delete user data-
      delete clientInfo[socket.id];

    }
  });

  // for private chat
  socket.on('joinRoom', function(req) {
    clientInfo[socket.id] = req;
    socket.join(req.room);
    //broadcast new user joined room
    socket.broadcast.to(req.room).emit("message", {
      name: "System",
      text: req.name + ' has joined',
      timestamp: moment().valueOf()
    });

  });

  // to show who is typing Message

  socket.on('typing', function(message) { // broadcast this message to all users in that room
    socket.broadcast.to(clientInfo[socket.id].room).emit("typing", message);
  });

  // to check if user seen Message
  socket.on("userSeen", function(msg) {
    socket.broadcast.to(clientInfo[socket.id].room).emit("userSeen", msg);
    //socket.emit("message", msg);

  });

  socket.emit("message", {
    text: "Welcome to My Chat Application!",
    timestamp: moment().valueOf(),
    name: "- System"
  });
  
  
    socket.emit("message", {
    text: "To start, share the link in the url bar to your friends or share the chat room with them. Please type anything in the text box below to start chatting.",
    timestamp: moment().valueOf(),
    name: "- Tip"
  });

  
    socket.emit("message", {
    text: "Here are a list of emoji: ðŸ˜‚ â¤ï¸ ðŸ˜	ðŸ˜Š ðŸ™ ðŸ’• ðŸ˜­ ðŸ‘ ðŸ˜… ðŸ‘ ðŸ˜ â™¥ï¸ ðŸ”¥ ðŸ’” ðŸ’– ðŸ’™ ðŸ˜¢ ðŸ¤” ðŸ˜† ðŸ™„ ðŸ’ª ðŸ˜‰ â˜ºï¸ ðŸ‘Œ ðŸ¤—ðŸ’œ ðŸ˜” ðŸ˜Ž ðŸ˜‡ ðŸŒ¹ ðŸ¤¦ ðŸŽ‰ â€¼ï¸ ðŸ’ž âœŒï¸ âœ¨ ðŸ¤· ðŸ˜± ðŸ˜Œ ðŸŒ¸ ðŸ™Œ ðŸ˜‹ ðŸ’— ðŸ’š ðŸ˜ ðŸ’› ðŸ™‚ ðŸ’“ ðŸ¤© ðŸ˜„ ðŸ˜€ ðŸ–¤ ðŸ˜ƒ ðŸ’¯ ðŸ™ˆ ðŸ‘‡ ðŸŽ¶ ðŸ˜’ ðŸ¤­ â£ï¸â— ðŸ˜œ ðŸ’‹ ðŸ‘€ ðŸ˜ª ðŸ˜‘ ðŸ’¥ ðŸ™‹ ðŸ˜ž ðŸ˜© ðŸ˜¡ ðŸ¤ª ðŸ‘Š â˜€ï¸ ðŸ˜¥ ðŸ¤¤ ðŸ‘‰ ðŸ’ƒ ðŸ˜³ âœ‹ ðŸ˜š ðŸ˜ ðŸ˜´ ðŸŒŸ ðŸ˜¬ ðŸ™ƒ ðŸ€ ðŸŒ· ðŸ˜» ðŸ˜“ â­ âœ… ðŸŒˆ ðŸ˜ˆ ðŸ¤˜ðŸ’¦ âœ”ï¸ ðŸ˜£ ðŸƒ ðŸ’ â˜¹ï¸ ðŸŽŠ ðŸ’˜ ðŸ˜  â˜ï¸ ðŸ˜• ðŸŒº ðŸŽ‚ ðŸŒ» ðŸ˜ ðŸ–• ðŸ’ ðŸ™Š ðŸ˜¹ ðŸ—£ï¸ ðŸ’« ðŸ’€ ðŸ‘‘ ðŸŽµ ðŸ¤ž ðŸ˜› ðŸ”´ ðŸ˜¤ ðŸŒ¼ ðŸ˜« âš½ ðŸ¤™ â˜• ðŸ† ðŸ§¡ ðŸŽ âš¡ ðŸŒž ðŸŽˆ âŒ âœŠ ðŸ‘‹ ðŸ˜² ðŸŒ¿ ðŸ¤« ðŸ‘ˆ ðŸ˜® ðŸ™† ðŸ» ðŸƒ ðŸ¶ ðŸ’ ðŸ˜° ðŸ¤¨ ðŸ˜¶ ðŸ¤ ðŸš¶ ðŸ’° ðŸ“ ðŸ’¢ðŸ‡ºðŸ‡¸ ðŸ¤Ÿ ðŸ™ ðŸš¨ ðŸ’¨ ðŸ¤¬ âœˆï¸ ðŸŽ€ ðŸº ðŸ¤“ ðŸ˜™ ðŸ’Ÿ ðŸŒ± ðŸ˜– ðŸ‘¶ â–¶ï¸ âž¡ï¸ â“ ðŸ’Ž ðŸ’¸ â¬‡ï¸ ðŸ˜¨ ðŸŒš ðŸ¦‹ ðŸ˜· ðŸ•º âš ï¸ ðŸ™… ðŸ˜Ÿ ðŸ˜µ ðŸ‘Ž ðŸ¤² ðŸ¤  ðŸ¤§ ðŸ“Œ ðŸ”µ ðŸ’… ðŸ§ ðŸ¾ ðŸ’ ðŸ˜— ðŸ¤‘ ðŸš€ ðŸŒŠ ðŸ¤¯ ðŸ· â˜Žï¸ ðŸ’§ ðŸ˜¯ ðŸ’† ðŸ‘† ðŸŽ¤ ðŸ™‡ ðŸ‘ â„ï¸ ðŸŒ´ ðŸ‡§ðŸ‡· ðŸ’£ ðŸ¸ ðŸ’Œ ðŸ“ ðŸ¥€ ðŸ¤¢ ðŸ‘… ðŸ’¡ ðŸ’© â‰ï¸ ðŸ‘ ðŸ“¸ ðŸ‘» ðŸ¤ ðŸ¤® ðŸŽ¼ âœï¸ ðŸš© ðŸŽ ðŸŠ ðŸ‘¼ ðŸ’ ðŸ“£ ðŸ¥‚ â¤µï¸ ðŸ“± â˜” ðŸŒ™ðŸ¾ ðŸŽ§ ðŸ â­• ðŸ€ â˜ ï¸ âš« ðŸ–ï¸ ðŸ˜§ ðŸŽ¯ ðŸ“² â˜˜ï¸ ðŸ‘ï¸ ðŸ· ðŸ‘„ ðŸŸ ðŸ° ðŸ’¤ ðŸ•Šï¸ ðŸ“º ðŸ’­ ðŸ± ðŸ ðŸ‡²ðŸ‡½ ðŸ§š ðŸ” ðŸ“¢ ðŸ“· ðŸ• ðŸŽ¸ ðŸ”« ðŸ¤š ðŸ­ ðŸ† ðŸ’‰ ðŸŒŽ ðŸ˜¦ ðŸŒ€ ðŸ‘¿ â˜‘ï¸ ðŸŽ¥ ðŸŒ§ï¸ ðŸ‘½ ðŸ‹ ðŸ¤’ ðŸ¤¡ ðŸ« ðŸ“š ðŸ ðŸ¤• ðŸ¦„ ðŸ… ðŸš— ðŸš« ðŸ’µ âš¾ ðŸ”ª ðŸ”” â™¨ï¸ ðŸŒ³ ðŸ”Š ðŸ¬ ðŸ’ ðŸ¼ ðŸœ ðŸ¼ ðŸ™‰ ðŸˆ ðŸ» ðŸ¤¸ ðŸŒ ðŸ‘¸ ðŸ• ðŸŒ ðŸ¦ âšª ðŸ‘© ðŸ˜¿ ðŸ‚ ðŸ“ž â° ðŸ”ž ðŸŒ ðŸŒ  ðŸ™€ â–ªï¸ â˜ï¸ ðŸ‘¹ ðŸ‰ ðŸ¥ ðŸŒ¶ï¸ 1ï¸âƒ£ ðŸŒµ ðŸ‡®ðŸ‡³ ðŸ‘§ ðŸ„ ðŸ‘® ðŸ’® ðŸ° ðŸ”· ðŸŒ¾ ðŸ”¹ ðŸ‡¹ðŸ‡· ðŸ¥‡ ðŸ‡®ðŸ‡¹ðŸª ðŸ‡¦ðŸ‡· ðŸ›‘ ðŸ ðŸŽ“ ðŸ‡¨ðŸ‡¦ ðŸ ðŸ¦ ðŸ˜½ ðŸš¬ ðŸ– ðŸ´ ðŸ†˜ ðŸ¤œ ðŸ¿ ðŸ” ðŸ“ ðŸ‡¯ðŸ‡µ ðŸ® ðŸ‡ 2ï¸âƒ£ ðŸ  ðŸ¤° ðŸ£ ðŸ’ ðŸ‘¦ ðŸ© ðŸ£ ðŸ¤› ðŸ‘¯ ðŸ³ï¸â€ðŸŒˆ â™ ï¸ ðŸŒ² ðŸ´ ðŸ› ðŸŽ† ðŸ’‘ ðŸž ðŸ¯ â˜„ï¸ ðŸ˜¸ ðŸš ðŸŽ¬ ðŸŽ™ï¸ ðŸ‡¨ðŸ‡´ ðŸ³ ðŸ¦€ ðŸ¥ƒ ðŸ”¸ ðŸ’Š ðŸŽ ðŸ¹ â™¦ï¸ ðŸ”® ðŸ‘¨ ðŸ¸ ðŸŒ ðŸ‘´ ðŸ§¢ ðŸ½ ðŸ” ðŸŽ» â¬†ï¸ âœ‚ï¸ ðŸ‘« ðŸ‘£ ðŸ¯ ðŸŽ® ðŸµ ðŸ¦ ðŸ‡¬ðŸ‡§ ã€°ï¸ ðŸ‘­ ðŸ¬ ðŸŸ ðŸ‘™ âœ–ï¸ ðŸ“© ðŸ‘µ ðŸ¨ ðŸ‡«ðŸ‡· ðŸ– âœï¸ â™»ï¸ ðŸ¥Š ðŸ¦… ðŸ’¬ ðŸ‡¨ðŸ‡± ðŸ¢ ðŸ”° ðŸ”¶ ðŸŽ—ï¸ ðŸ’„ ðŸ‘  ðŸ¥• âž– ðŸº ðŸ“– ðŸ ðŸŒƒ âœ´ï¸ ðŸŒŒ ðŸ“ ðŸ‘‚ ðŸ¤ ðŸ ðŸ”» ðŸ’» ðŸ¦ ðŸ‡©ðŸ‡ª ðŸŒ› â†˜ï¸ âœï¸ ðŸ§˜ ðŸ¥ ðŸ–ï¸ âšœï¸ â• ðŸ…°ï¸ ðŸš´ ðŸ’  ãŠ—ï¸ ðŸ™ â™£ï¸ ðŸ¡ â© ðŸŽ¨ ðŸ  ðŸ‡°ðŸ‡· ðŸ— ðŸš® â–«ï¸ ðŸŒªï¸ ðŸ˜¼ ðŸ‘¤ ðŸŠ ðŸŒ½ ðŸŽ© ðŸ‡ªðŸ‡¸ ðŸŽ¹ ðŸˆ â—€ï¸ â†”ï¸ ðŸ¡ ðŸ‡µðŸ‡° ðŸŽ‡ ðŸ¥© ðŸž 3ï¸âƒ£ â¬…ï¸ ðŸŒ â†—ï¸ ðŸ½ï¸ ðŸ§€ ðŸ¥¦ ðŸœ âš”ï¸ðŸ˜º ðŸ¥ž ðŸ„ ðŸ”¨ ðŸï¸ ðŸ”† ðŸ‘¥ ðŸ‘“ ðŸ¥’ ðŸˆ ðŸ‡µðŸ‡­ ðŸ‹ï¸ 0ï¸âƒ£ ðŸš˜ ðŸ¦– ðŸŒ• ðŸŽ­ ðŸ‘¾ ðŸ³ ðŸµï¸ ðŸ§ ðŸ”— ðŸ•‹ â˜ƒï¸ ðŸŒ… ðŸ¤´ ðŸ–– ðŸŠ ðŸ˜ ðŸŒ¤ï¸ ðŸ¥‘ ðŸ¥š â›ˆï¸ ðŸµ ðŸ”œ ðŸ¶ ðŸ„ ðŸ‡»ðŸ‡ª ðŸ® ðŸ¦ˆ ðŸš² â›” ðŸ•¯ï¸ âž• ðŸ”º ðŸ’‡ ðŸ§  ðŸ“» ðŸ¥¤ ðŸ ðŸ¥ ðŸ’´ ðŸŒ¬ï¸ ðŸ¥“ ðŸ™ âš“ ðŸ‘° ðŸ‚ ðŸ“½ï¸ ðŸ… â›… ðŸ‡¦ðŸ‡ª ðŸ‡µðŸ‡ª ðŸ§œ ðŸ“® â›³ ðŸ”½ ðŸš‚ ðŸŒï¸ ðŸ‡ ðŸï¸ ðŸŽ² ðŸ¥› ðŸŽ£ ðŸ‘± ðŸŽ ðŸ•·ï¸ ðŸ¦ ðŸ”˜ ðŸ… ðŸ‡ ðŸ” ðŸ© ðŸ‘º ðŸ…±ï¸ ðŸš™ ðŸ§ âš–ï¸ ðŸŽƒ ðŸŒ„ ðŸŽ¾ ðŸš ðŸŽº â‡ï¸ ðŸŽ« âŒš ðŸŒ‹ ðŸ’’ ðŸ‘³ âŽ ðŸ‘Ÿ ðŸ‘ƒ ðŸ›Œ ðŸš“ â¬ ðŸ“ˆ â›„ â±ï¸ ðŸ˜¾ ðŸ›« ðŸ¤± ðŸ â˜®ï¸ ðŸšƒ â³ ðŸŒœ ðŸ“¹ ðŸ› ðŸ‘” ðŸ‘— ðŸŒ ðŸŽ± ðŸŒ° ðŸŒ® ðŸ•µï¸ ðŸ”… âœ‰ï¸ ðŸ‡ªðŸ‡¬ ðŸš‘ ðŸ“¦ ðŸ¤¥ ðŸ”„ ðŸ¤³ ðŸ’² ðŸŽ‹ ðŸ—“ï¸ ðŸ¤– ðŸ¥” ðŸ†— ðŸ”‘ ðŸ‡¨ðŸ‡³ ðŸ¤ 4ï¸âƒ£ ðŸ‘ âž° ðŸ‘©â€ðŸŽ“ â˜‚ï¸ ðŸ‡¦ðŸ‡¹ ðŸ¦† ðŸšŒ ðŸ’¿ ðŸ¥ ðŸ‹ ðŸš’ ðŸ ðŸ‡ªðŸ‡¨ ðŸ¥ ðŸŽ· ðŸ—½ ðŸ—¡ï¸ ðŸ ðŸ­ ðŸ™Ž ðŸŒ‘ ðŸš” ðŸ‡®ðŸ‡© ðŸš¿ ðŸ¥ ðŸ•Œ ðŸ€ ðŸ›¡ï¸ ðŸ”’ âœ³ï¸ ðŸ•¶ï¸ ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘© ðŸŽŸï¸ ðŸ‰ ðŸ”± ðŸ”Ž ðŸ‡¦ðŸ‡º âš°ï¸ ðŸ© ðŸ¦‘ ðŸ§Ÿ ðŸ†• ðŸ¦Š ðŸ‘• ðŸ¹ ðŸ‡©ðŸ‡¿ ðŸ‘¬ ðŸ± ðŸ“° ðŸ¥‹ ðŸš¤ ðŸ° 5ï¸âƒ£ ðŸ¦‰ ðŸš¢ ðŸŒ¨ï¸ ðŸ“† ðŸ—ï¸ ðŸŽŒ ðŸ§” ðŸ’³ ðŸ‡ºðŸ‡¾ ðŸ¥— â˜¯ï¸ âš™ï¸ ðŸ’¶ â›©ï¸ ðŸ—» âœ’ï¸ ðŸ‡ºðŸ‡² ðŸ‡µðŸ‡¹ ðŸ ðŸ‘· ðŸ›ï¸ ðŸŽï¸ ðŸ”› ðŸ”™ ðŸ—¼ ðŸŽ–ï¸ ðŸšº ðŸ¹ ðŸ¥– ðŸ‡µðŸ‡· ðŸŽ¡ ðŸ” ðŸŸï¸ ðŸ–¥ï¸ ðŸŒ­ ðŸ‡¹ðŸ‡­ âœ¡ï¸ ðŸ’ ðŸ›€ ðŸ“… ðŸ–‹ï¸ ðŸ‡¸ðŸ‡ª ðŸŽžï¸ ðŸŽª ðŸ™ ðŸ› ðŸ“• ðŸ‘’ ðŸ–‡ï¸ â” ðŸŽ„ ðŸ•¸ï¸ ðŸ¥œ ðŸ•´ï¸ ðŸ¥Ÿ â†™ï¸ â—¾ ðŸ² ðŸ´ ðŸ¦Œ ðŸ†” ðŸ‘› ðŸšš â†ªï¸ ðŸ‡¬ðŸ‡· ðŸ“¿ ðŸŒ«ï¸ ðŸŒ‚ ðŸ•‰ï¸ ðŸ†š ðŸ“‰ ðŸ—¨ï¸ ðŸ›’ ðŸ“› ðŸ‡³ðŸ‡± ðŸ¿ï¸ ðŸ…¾ï¸ â˜¢ï¸ ðŸ‡²ðŸ‡¦ ðŸƒ â›½ ðŸ…¿ï¸ ðŸ¦‡ â¤´ï¸ â›µ ðŸ‘ž ðŸ”“ ðŸ§ž â›°ï¸ ðŸ“Ž ðŸ¦Ž ðŸ”Œ ðŸ³ï¸ ðŸš½ ðŸ² âš’ï¸ â™Š ðŸ‘¢ ðŸ§™ ðŸ‡µðŸ‡± â›ª ðŸ‡§ðŸ‡ª ðŸŽŽ ðŸ”– ðŸ”‹ ðŸ“¡ ðŸŒ‡ ðŸ‰ ðŸ‘ª ðŸ‘– ðŸ“Š ðŸ† ðŸ” ðŸ›©ï¸ ðŸ¡ ðŸƒ ðŸ‘©â€ðŸ’» ðŸŒ©ï¸ ðŸ‡³ðŸ‡¬ ðŸ 6ï¸âƒ£ â›¹ï¸ ðŸ—¯ï¸ ðŸ‡¨ðŸ‡­ ðŸ¢ ðŸ—ºï¸ ðŸš• ðŸ‡·ðŸ‡º â“‚ï¸ â›±ï¸ ðŸ« ðŸ“€ ðŸ†™ ðŸ¤¼ ðŸ¨ ðŸ¦‚ ðŸ’· ðŸ¥ˆ ðŸ‘¨â€ðŸ’» ðŸ›ï¸ â—¼ï¸ ðŸš„ ðŸ§– ðŸŽ  ðŸ ðŸ—³ï¸ ðŸ® ðŸ¥ª ðŸŒ¥ï¸ ðŸšª ãŠ™ï¸ ðŸ—žï¸ ðŸ‘¨â€âš•ï¸ ðŸ–Šï¸ â¬› ðŸ†’ ðŸ‡¨ðŸ‡º ðŸ¥§ ðŸ‘©â€âš•ï¸ ðŸ‡³ðŸ‡® ðŸ‘¨â€ðŸŽ“ ðŸš§ â›“ï¸ ðŸ›µ ðŸ¥… ðŸš… ðŸ–¼ï¸ â™¿ ðŸ“ ðŸ€„ ðŸ–Œï¸ ðŸ‰ ðŸ“¬ ðŸš ðŸ—‘ï¸ ðŸ¤µ ðŸ·ï¸ ðŸŒ¡ï¸ ðŸŽ ðŸ‡¯ðŸ‡² ðŸ¦’ ðŸŽ’ ðŸ‡µðŸ‡¾ ðŸ‡ºðŸ‡¦ ðŸ‡²ðŸ‡¨ ðŸ¥‰ 7ï¸âƒ£ âŒ› ðŸŒ’ ðŸ¥¥ ðŸŽ… ðŸ§• ðŸ› â™‹ ðŸ§‘ ðŸ‡©ðŸ‡´ ðŸ‡®ðŸ‡ª ðŸ›¸ ðŸ§’ ðŸ“§ ðŸ¥¢ ðŸŽ¢ ðŸª ðŸ‡®ðŸ‡± ðŸ‘¨â€ðŸ³ ðŸš› ðŸ¥„ ðŸ¤¹ ðŸ¢ ðŸ’ˆ ðŸ‘˜ ðŸ‡³ðŸ‡´ ðŸ‡¬ðŸ‡­ ðŸ”ï¸ ã€½ï¸ ðŸš¦ ðŸ‡¿ðŸ‡¦ ðŸ‡¹ðŸ‡³ ðŸ’¼ â™ˆ ðŸ¦“ ðŸš» ðŸŽ° â—½ ðŸ¦— ðŸ¤¾ ðŸ‘š ðŸ‘¡ â›ï¸ 9ï¸âƒ£ ðŸ›Žï¸ ðŸ— ðŸŒ¦ï¸ ðŸ‡¸ðŸ‡¦ ðŸš¹ ðŸ‡¾ðŸ‡ª â˜ªï¸ ðŸ¤º ðŸš£ ðŸ—¿ ðŸ¥˜ ðŸ‡©ðŸ‡° ðŸ¦• ðŸ‡±ðŸ‡· ðŸ•ï¸ â˜£ï¸ ðŸŒ† â†•ï¸ ðŸ“¨ ðŸ¨ ðŸ•¹ï¸ ðŸ‘©â€ðŸ³ ðŸ‡¨ðŸ‡®ðŸ“¯ ðŸ‘œ ðŸ˜ï¸ ðŸ« â›º ðŸ‘©â€ðŸ« ðŸ•³ï¸ ðŸ¯ ðŸŒ“ ðŸŒ‰ 8ï¸âƒ£ ðŸ’‚ ðŸ”‰ ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ ðŸ‡ªðŸ‡º ðŸšœ ðŸ”• ðŸ“¥ ðŸŒ” ðŸ™ï¸ ðŸ¥¨ ðŸ‡²ðŸ‡¾ ðŸ“˜ ðŸ“— ðŸ“œ â™ ðŸ‡§ðŸ‡´ ðŸœï¸ ðŸ˜ ðŸ›¬ ðŸŒ¯ ðŸ—ï¸ ðŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ ðŸš¼ ðŸžï¸ ðŸ”ˆ ðŸ•°ï¸ ðŸ“ ðŸ‡¨ðŸ‡· ðŸ‘¨â€ðŸŒ¾ ðŸ¦ƒ ðŸ”¦ ðŸ”ƒ ðŸ‡¸ðŸ‡» ðŸ›³ï¸ ðŸŒ˜ ðŸ‡§ðŸ‡© ðŸ§› ðŸ‘©â€â¤ï¸â€ðŸ‘© ðŸ”š ðŸ”Ÿ â„¹ï¸ ðŸ›¢ï¸ ðŸ´ó §ó ¢ó ³ó £ó ´ó ¿ ðŸ‡¸ðŸ‡© ðŸ”­ ðŸ‡®ðŸ‡¶ ðŸŽ ðŸ¥£ ðŸŒ— â†–ï¸ ðŸŽ³ ðŸ‘¨â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨ ðŸ‘¨â€ðŸ« ðŸ“„ ðŸ‡¶ðŸ‡¦ ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ ðŸŽšï¸ ðŸ› ï¸ ðŸ†“ ðŸ‡µðŸ‡¸ ðŸ›ï¸ â™ ðŸ§¦ ðŸ—¾ ðŸ‘©â€ðŸŒ¾ ðŸŽ‘ ðŸ‡¬ðŸ‡¹ ðŸ§¤ ðŸ§ âž¿ ðŸ‡»ðŸ‡³ ðŸ“’ â™‰ â™“ ðŸš­ ðŸ”§ â™Œ â†©ï¸ â™’ ðŸ¦ ðŸˆµ ðŸ¥« ðŸŒ– ðŸ›´ ðŸš– ðŸ¥™ ðŸ›°ï¸ ðŸ¦ ðŸ‡¸ðŸ‡¬ âºï¸ ðŸ–ï¸ â›¸ï¸ ðŸ“™ ðŸ‘² ðŸ‚ *ï¸âƒ£ ðŸ”² ðŸ‡­ðŸ‡º ðŸš ðŸ‘¨â€â¤ï¸â€ðŸ‘¨ ðŸ”‡ ðŸ¦” ðŸ”¯ ðŸšµ ðŸš¯ ðŸ•› ðŸ“¼ ðŸ§“ ðŸŽ›ï¸ ðŸ‡¨ðŸ‡¿ ðŸ‡­ðŸ‡° ðŸ’º ðŸ‘©â€ðŸŽ¤ â›² âš›ï¸ ðŸ•’ ðŸ“¶ ðŸš‹ ðŸ‡±ðŸ‡§ ðŸ“  ðŸš‡ â²ï¸ âª ðŸ‡°ðŸ‡¼ ðŸ›ƒ ðŸ‡­ðŸ‡³ ðŸ‘¨â€âœˆï¸ ðŸ““ ðŸ‘©â€ðŸ‘§ â™Ž ðŸ‘ ðŸ“‹ ðŸ”¼ ðŸ‡¨ðŸ‡µ ðŸ‡¯ðŸ‡´ ðŸ“ƒ ðŸ”¬ ðŸ‡«ðŸ‡® ðŸš¥ ðŸ‡±ðŸ‡° â™ ðŸ‡µðŸ‡¦ ðŸ‡¸ðŸ‡¾ ðŸš¾ ðŸ‡­ðŸ‡· ðŸ‡³ðŸ‡¿ ðŸš ðŸ¸ ðŸ”³ ðŸ›‚ ðŸ“µ â›‘ï¸ ðŸšï¸ ðŸŽ½ ðŸš° ðŸª â›·ï¸ ðŸ‘©â€ðŸ’¼ â™‘ ðŸ‡¨ðŸ‡² ðŸ‡±ðŸ‡¾ â« ðŸ£ ðŸš‰ ðŸ›… âš•ï¸ â›´ï¸ ðŸ‘ï¸â€ðŸ—¨ï¸ ðŸ§ â—»ï¸ ðŸ‘©â€ðŸ”¬ â¹ï¸ ðŸ‡·ðŸ‡´ ðŸ‘©â€ðŸ‘¦ â¬œ#ï¸âƒ£ ðŸ‡¦ðŸ‡± ðŸ‡¹ðŸ‡¼ ðŸ›£ï¸ ðŸ¤ ðŸ›„ ðŸ‡®ðŸ‡¸ ðŸ¬ ðŸ‘¨â€ðŸŽ¤ ðŸ• ðŸŽ¦ ðŸ‘¨â€ðŸ’¼ ðŸ’¹ â˜¸ï¸ ðŸ“´ ðŸ“ ðŸ–±ï¸ ðŸ‡­ðŸ‡¹ ðŸ‡¸ðŸ‡³ ðŸ”© ðŸˆ² ðŸŽ´ ðŸ“³ â˜¦ï¸ ðŸš† ðŸ“ ðŸ“” ðŸ‡¦ðŸ‡« ðŸ‘©â€ðŸŽ¨ ðŸ•‘ ðŸš¸ ðŸ§£ ðŸ‘¨â€ðŸš€ ðŸ‡§ðŸ‡­ ðŸ­ ðŸº ðŸ‡¬ðŸ‡³ ðŸ¤½ ðŸ›¥ï¸ ðŸ‡²ðŸ‡± ðŸŒ ðŸ¤¶ ðŸ‡¦ðŸ‡¿ ðŸ’½ ðŸ‡¦ðŸ‡´ ðŸšŽ ðŸ‡®ðŸ‡· ðŸ‡³ðŸ‡µ ðŸ—’ï¸ ðŸ‡¨ðŸ‡© ðŸ›‹ï¸ âŒ¨ï¸ ðŸ†Ž ðŸ§— ðŸ§¥ ðŸ‡°ðŸ‡ª ðŸ›¶ ðŸ“‘ ðŸ‘ ðŸ‡¦ðŸ‡² â¯ï¸ ðŸ‡¬ðŸ‡ª ðŸ’± ðŸ‘¨â€ðŸŽ¨ ðŸ‡§ðŸ‡¬ ðŸ‡ªðŸ‡¦ ðŸ‘©â€âš–ï¸ ðŸ•“ ðŸ‘©â€ðŸš€ ðŸšž ðŸ‘¨â€ðŸš’ ðŸ†– ðŸ”€ ðŸ‘¨â€ðŸ”¬ ðŸ‘¨â€âš–ï¸ ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦ ðŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿ ðŸ¥  ðŸš³ ðŸ‡§ðŸ‡¯ ðŸ‡²ðŸ‡¬ ðŸ‡ªðŸ‡ª â­ï¸ ðŸ•Ž ðŸˆš ðŸš¡ ðŸ•• ðŸ‡·ðŸ‡¸ ðŸ‰‘ ðŸ“‚ ðŸ‡¹ðŸ‡¿ ðŸ“« ðŸ•˜ ðŸšŠ ðŸšˆ ðŸ”‚ âž— ðŸ•— ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§ ðŸˆ¹ ðŸ‡±ðŸ‡º ðŸ›¤ï¸ ðŸ‡ºðŸ‡¬ ðŸ•– ðŸˆ´ ðŸ‘¨â€ðŸ”§ ðŸ” ðŸ‡§ðŸ‡¼ ðŸš· ðŸ‡²ðŸ‡° ðŸ‡±ðŸ‡» ðŸ•™ ðŸ‡¹ðŸ‡¹ ðŸ‡±ðŸ‡¹ ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨ ðŸ‘¨â€ðŸ‘§ ðŸ“Ÿ ðŸ‘©â€âœˆï¸ â¸ï¸ ðŸ‘©â€ðŸš’ ðŸ‡¿ðŸ‡¼ ðŸ¥¡ ðŸ‡¸ðŸ‡° ðŸ•”ðŸ‡´ðŸ‡² ðŸ’¾ ðŸ“¤ âš—ï¸ ðŸ”  ðŸš ðŸ†‘ ðŸ‡²ðŸ‡² ðŸ‘¨â€ðŸ‘¦ ðŸ‡²ðŸ‡¹ ðŸ•š ðŸ‡§ðŸ‡¦ ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ ðŸŽ¿ ðŸ”¤ ðŸˆ¶ ðŸš± ðŸš ðŸ‡³ðŸ‡ª ðŸ‘©â€ðŸ”§ ðŸ‡§ðŸ‡¸ ðŸ• ðŸ‡°ðŸ‡­ ðŸ”¢ ðŸ‡¨ðŸ‡¾ ðŸ“­ ðŸ“ª ðŸˆ³ ðŸ‡²ðŸ‡· ðŸ‘©â€â¤ï¸â€ðŸ‘¨ ðŸ‘©â€ðŸ‘©â€ðŸ‘§ ðŸ‡°ðŸ‡¿ ðŸ–¨ï¸ â®ï¸ ðŸ‡¬ðŸ‡¾ ðŸ‡¸ðŸ‡® ðŸ‡§ðŸ‡¾ ðŸ‡¸ðŸ‡´ ðŸ•  ðŸ‡¦ðŸ‡¼ ðŸ–²ï¸ âš±ï¸ ðŸ‡²ðŸ‡ª ðŸ‡¿ðŸ‡² ðŸ‡§ðŸ‡§ ðŸ‡¹ðŸ‡¯ ðŸ‡¨ðŸ‡¬ ðŸ‡ºðŸ‡¿ ðŸ‡¸ðŸ‡± ðŸ‡³ðŸ‡¦ ðŸšŸ ðŸ‡§ðŸ‡® ðŸ‡½ðŸ‡° ðŸ‡¦ðŸ‡® ðŸ‡ªðŸ‡¹ ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§ ðŸ‡¦ðŸ‡¬ ðŸ‘¨â€ðŸ­ ðŸ‘©â€ðŸ‘§â€ðŸ‘§ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘§ ðŸˆ¯ ðŸš  ðŸ•Ÿ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ ðŸ‡·ðŸ‡¼ ðŸ‡¦ðŸ‡½ ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦ ðŸ‡«ðŸ‡¯ ðŸ¥Œ ðŸ‡¦ðŸ‡¸ ðŸ‡¹ðŸ‡© ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦ ðŸ‡¦ðŸ‡© ðŸ‡¬ðŸ‡² ðŸ‡¬ðŸ‡¦ ðŸ—‚ï¸ ðŸ‡§ðŸ‡² ðŸ‘©â€ðŸ­ðŸ• ðŸ•¦ ðŸ•¢ ðŸ•œ ðŸ‡²ðŸ‡³ ðŸ‡¹ðŸ‡¬ ðŸ•¤ ðŸ‡²ðŸ‡¿ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦ ðŸˆ‚ï¸ ðŸ‡¬ðŸ‡¼ ðŸ‡§ðŸ‡³ ðŸ‡²ðŸ‡» ðŸ•§ ðŸ‡²ðŸ‡´ ðŸ•¡ â›Ž ðŸ‡¹ðŸ‡´ ðŸ•£ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦ ðŸ‡ªðŸ‡· ðŸ‡¦ðŸ‡¨ ðŸ‡°ðŸ‡¬ ðŸ‡¦ðŸ‡¶ ðŸ‡¨ðŸ‡» ðŸ‡§ðŸ‡« ðŸ‡°ðŸ‡µ ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ ðŸ•¥ ðŸ‡²ðŸ‡© ðŸ‡®ðŸ‡¨ ðŸ‡»ðŸ‡¦ ðŸ‡¬ðŸ‡© ðŸ‡®ðŸ‡² ðŸ‘©â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦ ðŸ‡²ðŸ‡« ðŸ“‡ ðŸˆº ðŸ‡±ðŸ‡¦ ðŸ›· ðŸ•ž ðŸ‡²ðŸ‡¼ ðŸ‘©â€ðŸ‘©â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§ ðŸˆ·ï¸ ðŸ‘¨â€ðŸ‘§â€ðŸ‘§ ðŸ‡ºðŸ‡³ ðŸ—ƒï¸ ðŸ‡±ðŸ‡¸ ðŸ—œï¸ ðŸ‡¬ðŸ‡º ðŸ‡§ðŸ‡» ðŸ”¡ ðŸ‡«ðŸ‡´ ðŸ‡²ðŸ‡º ðŸ‡µðŸ‡¬ ðŸ‡¨ðŸ‡¼ ðŸ‡¬ðŸ‡¬ ðŸˆ ðŸ”£ ðŸ‡¼ðŸ‡¸ ðŸ‡¸ðŸ‡· ðŸ‡¹ðŸ‡² ðŸ‡¸ðŸ‡¸ ðŸ—„ï¸ ðŸ‡§ðŸ‡¹ ðŸ‡¸ðŸ‡½ ðŸ‡°ðŸ‡² ðŸˆ¸ ðŸ‡©ðŸ‡² ðŸ‡ªðŸ‡­ ðŸ‡§ðŸ‡¿ ðŸ‡»ðŸ‡® ðŸ‡¬ðŸ‡« ðŸ‡¸ðŸ‡² ðŸ‡©ðŸ‡¯ ðŸ‡¹ðŸ‡¨ðŸ‡±ðŸ‡¨ ðŸ‡»ðŸ‡º ðŸ‡µðŸ‡« ðŸ‡¬ðŸ‡® ðŸ‡¸ðŸ‡¨ ðŸ‡°ðŸ‡³ ðŸ‡¯ðŸ‡ª ðŸ‡²ðŸ‡¶ ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦ ðŸ‡·ðŸ‡ª ðŸ‡¸ðŸ‡¿ ðŸ‡°ðŸ‡¾ âï¸ ðŸ‡»ðŸ‡¨ ðŸ‡»ðŸ‡¬ ðŸ‡±ðŸ‡® ðŸ‡¨ðŸ‡¨ ðŸ‡¨ðŸ‡« ðŸ‡¸ðŸ‡¹ ðŸ‡¬ðŸ‡± ðŸ‡µðŸ‡¼ ðŸ‡¬ðŸ‡µ ðŸ‡­ðŸ‡² ðŸ‡¨ðŸ‡° ðŸ‡«ðŸ‡° ðŸ‡µðŸ‡³ ðŸ‡³ðŸ‡« ðŸ‡¸ðŸ‡§ ðŸ‡¹ðŸ‡± ðŸ‡«ðŸ‡² ðŸ‡®ðŸ‡´ ðŸ‡²ðŸ‡­ ðŸ‡¬ðŸ‡¶ ðŸ‡¹ðŸ‡°	ðŸ‡§ðŸ‡¶ ðŸ‡²ðŸ‡µ ðŸ‡¨ðŸ‡½ ðŸ‡°ðŸ‡® ðŸ‡³ðŸ‡º ðŸ‡¸ðŸ‡¯ ðŸ‡²ðŸ‡¸ ðŸ‡¸ðŸ‡­ ðŸ‡¹ðŸ‡» ðŸ‡³ðŸ‡¨ ðŸ‡³ðŸ‡· ðŸ‡§ðŸ‡± ðŸ‡¼ðŸ‡« ðŸ‡¬ðŸ‡¸",
    timestamp: moment().valueOf(),
    name: "- Tip"
  });
  
      socket.emit("message", {
    text: "Unfortunately, this app does not store logs of previous chat data, so if you close this tab, you'll lose your progress. I tested the code out using mah 2 chromebooks and it seems to work fine. Another thing: because the school blocked notifications, it won't alert you if a message comes up unless if you visit using a home computer.",
    timestamp: moment().valueOf(),
    name: "- Admin Message (Zetong)"
  });

  // listen for client message
  socket.on("message", function(message) {
    console.log("Message Received : " + message.text);
    // to show all current users
    if (message.text === "@currentUsers") {
      sendCurrentUsers(socket);
    } else {
      //broadcast to all users except for sender
      message.timestamp = moment().valueOf();
      //socket.broadcast.emit("message",message);
      // now message should be only sent to users who are in same room
      socket.broadcast.to(clientInfo[socket.id].room).emit("message", message);
      //socket.emit.to(clientInfo[socket.id].room).emit("message", message);
    }

  });
});
http.listen(PORT, function() {
  console.log("server started");
});


//init socket io and whatever 
var files = {}, 
    struct = { 
        name: null, 
        type: null, 
        size: 0, 
        data: [], 
        slice: 0, 
    };

socket.on('slice upload', (data) => { 
    if (!files[data.name]) { 
        files[data.name] = Object.assign({}, struct, data); 
        files[data.name].data = []; 
    }
    
    //convert the ArrayBuffer to Buffer 
    data.data = new Buffer(new Uint8Array(data.data)); 
    //save the data 
    files[data.name].data.push(data.data); 
    files[data.name].slice++;
    
    if (files[data.name].slice * 100000 >= files[data.name].size) { 
        //do something with the data 
        socket.emit('end upload'); 
    } else { 
        socket.emit('request slice upload', { 
            currentSlice: files[data.name].slice 
        }); 
    } 
});
